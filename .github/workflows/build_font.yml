name: Build Fonts

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    # 1. Install System Tools (7zip)
    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y p7zip-full build-essential

    # 2. Build and Install OTFCC (Font Tools)
    # The ruby script relies on otfccdump and otfccbuild
    - name: Build and Install otfcc
      run: |
        git clone https://github.com/caryll/otfcc.git
        cd otfcc
        # Use premake to generate makefiles, then build
        ./dep/bin-linux/premake5 gmake
        cd build/gmake
        make config=release_x64
        # Move binaries to a path in system $PATH
        sudo cp ../../bin/release-x64/otfccdump /usr/local/bin/
        sudo cp ../../bin/release-x64/otfccbuild /usr/local/bin/
        # Verify installation
        otfccdump --version

    # 3. Setup Ruby
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'

    # 4. Run the build script
    - name: Run Font Build Script
      run: ruby build_font.rb

    # 5. Save the Output (TTF) as an Artifact
    - name: Upload TTF Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Generated Fonts
        path: outputs/*.ttf

    # 6. Save the Source (ZIP) as an Artifact
    - name: Upload Source Zip
      uses: actions/upload-artifact@v4
      with:
        name: Source JSON Zip
        path: source/*.zip