name: Build TTF from JSON

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Check and Install otfcc
      run: |
        if ! command -v otfccbuild &> /dev/null; then
          echo "otfcc not found, installing..."
          sudo apt-get update
          sudo apt-get install -y wget unzip g++ make

          wget https://github.com/premake/premake-core/releases/download/v5.0.0-alpha15/premake-5.0.0-alpha15-linux.tar.gz -O premake.tar.gz
          tar -xzf premake.tar.gz
          sudo mv premake5 /usr/local/bin/

          wget https://github.com/caryll/otfcc/archive/v0.10.4.tar.gz -O otfcc-source.tar.gz
          tar -xzf otfcc-source.tar.gz

          cd otfcc-0.10.4
          premake5 gmake
          cd build/gmake
          make config=release_x64

          echo "Debug: list possible output binaries"
          find ../../bin -maxdepth 3 -type f -name 'otfcc*' -print || true

          if [ -f ../../bin/release-x64/otfccbuild ] && [ -f ../../bin/release-x64/otfccdump ]; then
            sudo mv ../../bin/release-x64/otfccbuild /usr/local/bin/
            sudo mv ../../bin/release-x64/otfccdump /usr/local/bin/
          elif [ -f ../../bin/release_x64/otfccbuild ] && [ -f ../../bin/release_x64/otfccdump ]; then
            # fallback (just in case the folder name differs)
            sudo mv ../../bin/release_x64/otfccbuild /usr/local/bin/
            sudo mv ../../bin/release_x64/otfccdump /usr/local/bin/
          else
            echo "Build failed: cannot locate otfccbuild/otfccdump under otfcc-0.10.4/bin"
            echo "Hint: expected ../../bin/release-x64/otfccbuild"
            exit 1
          fi

          echo "Installed:"
          otfccbuild --version || true
        else
          echo "otfcc is already installed."
          otfccbuild --version || true
        fi

    - name: Decompress JSON (all *.json.zip)
      run: |
        rm -rf decompressed
        mkdir -p decompressed

        shopt -s nullglob
        zips=(source/*.json.zip)
        if [ ${#zips[@]} -eq 0 ]; then
          echo "No source/*.json.zip found."
          exit 1
        fi

        for z in "${zips[@]}"; do
          echo "Unzipping: $z"
          unzip -o "$z" -d decompressed
        done

        echo "Decompressed JSON files:"
        ls -la decompressed/*.json

    - name: Build TTF (all decompressed/*.json)
      run: |
        mkdir -p output

        shopt -s nullglob
        jsons=(decompressed/*.json)
        if [ ${#jsons[@]} -eq 0 ]; then
          echo "No decompressed/*.json found."
          exit 1
        fi

        for j in "${jsons[@]}"; do
          base="$(basename "$j" .json)"
          out="output/${base}.ttf"
          echo "Building: $j -> $out"
          otfccbuild "$j" -o "$out"
        done

        echo "Built TTF files:"
        ls -la output/*.ttf

    - name: Upload built TTFs (artifact)
      uses: actions/upload-artifact@v4
      with:
        name: built-ttf
        path: output/*.ttf
        if-no-files-found: error